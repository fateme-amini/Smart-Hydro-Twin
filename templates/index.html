<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ULTIMATE DIGITAL TWIN | Blue-Tech Series</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-grad-start: #ffffff;
            --bg-grad-end: #dceefc;
            --panel-bg: rgba(255, 255, 255, 0.92);
            --primary: #0066ff;
            --accent: #00d4ff;
            --danger: #ff0055;
            --text-main: #0f172a;
            --text-sub: #64748b;
        }

        body { margin: 0; overflow: hidden; background: #eef2f6; font-family: 'Rajdhani', sans-serif; color: var(--text-main); }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: radial-gradient(circle at center, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%); }

        /* UI Layer Layout */
        .ui-layer {
            position: absolute; inset: 0; pointer-events: none; z-index: 10;
            display: grid;
            grid-template-columns: 300px 1fr 340px;
            grid-template-rows: 80px 1fr 100px;
            gap: 20px; padding: 20px; box-sizing: border-box;
        }

        /* Panel Styling */
        .panel {
            background: var(--panel-bg); backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.6); border-radius: 12px;
            padding: 16px; box-shadow: 0 10px 30px -10px rgba(0, 102, 255, 0.15);
            pointer-events: auto; display: flex; flex-direction: column; border-left: 3px solid var(--primary);
        }
        .panel-title { font-size: 14px; font-weight: 700; color: var(--text-sub); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 12px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }

        /* Sections */
        .header { grid-column: 1 / 2; grid-row: 1; display: flex; align-items: center; gap: 15px; pointer-events: auto; }
        .logo-box { width: 50px; height: 50px; background: linear-gradient(135deg, #0066ff, #00d4ff); color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 8px 20px rgba(0, 102, 255, 0.3); }
        .telemetry-panel { grid-column: 1; grid-row: 2; overflow-y: auto; }
        .data-row { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .data-label { font-weight: 600; font-size: 14px; color: #475569; display: flex; gap: 8px; align-items: center; }
        .data-val { font-family: 'JetBrains Mono'; font-weight: 700; color: var(--primary); background: #f0f7ff; padding: 4px 8px; border-radius: 6px; }
        .logs-panel { grid-column: 3; grid-row: 1 / 3; gap: 15px; }
        .ai-display { background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center; }
        .ai-status-text { font-size: 26px; font-weight: 800; margin: 5px 0; }
        .log-box { flex: 1; overflow-y: auto; background: #f8fafc; border-radius: 6px; padding: 10px; font-family: 'JetBrains Mono'; font-size: 11px; border: 1px solid #e2e8f0; }
        .log-line { margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid #eee; display: flex; gap: 6px; }
        .log-time { color: #94a3b8; }
        .controls-area { grid-column: 2; grid-row: 3; display: flex; justify-content: center; align-items: flex-end; pointer-events: none; }
        .btn-group { pointer-events: auto; background: white; padding: 10px 15px; border-radius: 50px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); display: flex; gap: 10px; border: 1px solid #e2e8f0; }
        
        button { border: none; background: #f1f5f9; color: var(--text-sub); padding: 12px 24px; border-radius: 30px; font-family: 'Rajdhani'; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
        button:hover { background: #e2e8f0; color: var(--text-main); transform: translateY(-2px); }
        button.active { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(0, 102, 255, 0.4); }
        button.danger:hover { background: #fff0f5; color: var(--danger); }
        button.danger.active { background: var(--danger); color: white; box-shadow: 0 4px 15px rgba(255, 0, 85, 0.4); }

        /* Overlay */
        #alarm-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; background: radial-gradient(circle, transparent 20%, rgba(255, 0, 85, 0.15) 100%); display: none; animation: pulseAlarm 1s infinite; }
        @keyframes pulseAlarm { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="alarm-overlay"></div>
    <div id="canvas-container"></div>

    <div class="ui-layer">
        <div class="header">
            <div class="logo-box"><i class="fas fa-cube"></i></div>
            <div>
                <div style="font-size: 20px; font-weight: 800; letter-spacing: -0.5px;">HYDRA-TWIN</div>
                <div style="font-size: 12px; color: var(--text-sub); font-weight:600;">AI ACOUSTIC SURVEILLANCE</div>
            </div>
        </div>

        <div class="panel telemetry-panel">
            <div class="panel-title">
                <span><i class="fas fa-network-wired"></i> Sensor Array</span>
                <i class="fas fa-circle" style="color:#10b981; font-size:10px;"></i>
            </div>
            <div class="data-row">
                <span class="data-label"><i class="fas fa-tachometer-alt"></i> Hydro Pressure</span>
                <span class="data-val" id="val-p1">-- Bar</span>
            </div>
            <div class="data-row">
                <span class="data-label"><i class="fas fa-wave-square"></i> Vibration (RMS)</span>
                <span class="data-val" id="val-vib">-- g</span>
            </div>
            <div class="data-row">
                <span class="data-label"><i class="fas fa-volume-up"></i> Acoustic Level</span>
                <span class="data-val" id="val-db">-- dB</span>
            </div>
        </div>

        <div class="panel logs-panel">
            <div class="panel-title"><span><i class="fas fa-robot"></i> Neural Network</span></div>
            <div class="ai-display">
                <div style="font-size:11px; text-transform:uppercase; color:#94a3b8;">Predicted State</div>
                <div id="ai-status" class="ai-status-text" style="color:#10b981;">INITIALIZING</div>
                <div style="font-size:12px; margin-top:5px;">Confidence: <span id="ai-conf" style="font-weight:bold;">0.0%</span></div>
                <canvas id="fft" style="width:100%; height:60px; background:#f8fafc; margin-top:10px; border-radius:4px;"></canvas>
            </div>
            <div class="panel-title" style="margin-top:10px;"><span><i class="fas fa-history"></i> Event Log</span></div>
            <div class="log-box" id="log-feed"></div>
        </div>

        <div class="controls-area">
            <div class="btn-group">
                <button class="active" onclick="setScenario('NL', this)"><i class="fas fa-shield-alt"></i> NORMAL</button>
                <button class="danger" onclick="setScenario('GL', this)"><i class="fas fa-tint"></i> GASKET LEAK</button>
                <button class="danger" onclick="setScenario('LC', this)"><i class="fas fa-compress-arrows-alt"></i> LONG. CRACK</button>
                <button class="danger" onclick="setScenario('CC', this)"><i class="fas fa-ring"></i> CIRC. CRACK</button>
                <button class="danger" onclick="setScenario('OL', this)"><i class="fas fa-bullseye"></i> ORIFICE LEAK</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. THREE.JS SCENE SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xeef2f6);
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(18, 18, 24);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);
        
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        // --- 2. MATERIALS ---
        const pipeMat = new THREE.MeshPhongMaterial({ color: 0x0066ff, transparent: true, opacity: 0.3, shininess: 100 });
        const waterMat = new THREE.MeshBasicMaterial({ color: 0x00ffff }); // Inner flow
        const jointMat = new THREE.MeshStandardMaterial({ color: 0x0f172a });

        // --- 3. BUILD PIPE NETWORK ---
        const pipeGroup = new THREE.Group();
        scene.add(pipeGroup);

        function createPipe(start, end) {
            const path = new THREE.LineCurve3(start, end);
            const geometry = new THREE.TubeGeometry(path, 1, 0.8, 16, false);
            const mesh = new THREE.Mesh(geometry, pipeMat);
            pipeGroup.add(mesh);
            
            // Add Joints at ends
            const jointGeo = new THREE.SphereGeometry(1.0, 32, 32);
            const joint = new THREE.Mesh(jointGeo, jointMat);
            joint.position.copy(start);
            pipeGroup.add(joint);
        }

        // Loop Configuration
        createPipe(new THREE.Vector3(-10, 2, -6), new THREE.Vector3(10, 2, -6));
        createPipe(new THREE.Vector3(10, 2, -6), new THREE.Vector3(10, 2, 6));
        createPipe(new THREE.Vector3(10, 2, 6), new THREE.Vector3(-10, 2, 6));
        createPipe(new THREE.Vector3(-10, 2, 6), new THREE.Vector3(-10, 2, -6));
        createPipe(new THREE.Vector3(0, 2, -6), new THREE.Vector3(0, 2, 6)); // Cross pipe

        // Floor Grid
        const grid = new THREE.GridHelper(50, 50, 0xcceeff, 0xeef2f6);
        scene.add(grid);

        // Lights
        const ambient = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambient);
        const sun = new THREE.DirectionalLight(0xffffff, 1.2);
        sun.position.set(20, 30, 10);
        scene.add(sun);

        // --- 4. ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // --- 5. BACKEND INTERACTION LOGIC ---
        let isAlarm = false;

        function addLog(msg, isBad) {
            const div = document.createElement('div');
            div.className = 'log-line';
            const time = new Date().toLocaleTimeString('en-US', {hour12:false});
            div.innerHTML = `<span class="log-time">[${time}]</span> <span style="color:${isBad?'#ff0055':'#0066ff'}; font-weight:bold;">${msg}</span>`;
            const feed = document.getElementById('log-feed');
            feed.prepend(div);
        }

        // Handle Button Clicks
        function setScenario(type, btn) {
            document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Call Backend API
            fetch('/api/set_scenario', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ type: type })
            });
        }

        // Poll for Updates (1Hz)
        setInterval(() => {
            fetch('/api/predictive_analytics')
                .then(r => r.json())
                .then(data => {
                    // Update UI Numbers
                    document.getElementById('val-p1').innerText = data.telemetry.pressure;
                    document.getElementById('val-vib').innerText = data.telemetry.vibration;
                    document.getElementById('val-db').innerText = data.telemetry.acoustic;
                    
                    // Update AI Status
                    const statusElem = document.getElementById('ai-status');
                    statusElem.innerText = data.ai_prediction;
                    document.getElementById('ai-conf').innerText = data.confidence + "%";

                    // Handle Alarm Visuals
                    if(data.ai_prediction !== 'NL') {
                        if(!isAlarm) {
                            addLog(`CRITICAL: ${data.ai_prediction} Detected!`, true);
                            isAlarm = true;
                        }
                        statusElem.style.color = "#ff0055";
                        document.getElementById('alarm-overlay').style.display = 'block';
                        pipeMat.color.setHex(0xff0055); // Turn pipes red
                    } else {
                        if(isAlarm) {
                            addLog("System Restored to Normal.", false);
                            isAlarm = false;
                        }
                        statusElem.style.color = "#10b981";
                        document.getElementById('alarm-overlay').style.display = 'none';
                        pipeMat.color.setHex(0x0066ff); // Turn pipes blue
                    }

                    // Visualize FFT
                    const ctx = document.getElementById('fft').getContext('2d');
                    ctx.clearRect(0,0,300,60);
                    ctx.fillStyle = isAlarm ? '#ff0055' : '#0066ff';
                    (data.fft || []).forEach((val, i) => {
                        let h = Math.min(val * 3, 60);
                        ctx.fillRect(i*6, 60-h, 4, h);
                    });
                });
        }, 1000);

        // Handle Resize
        window.onresize = () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>